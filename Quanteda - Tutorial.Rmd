---
title: "IDS Workshop - Quanteda"
subtitle: "How we met Quanteda - Analyzing the TV show ‘How I Met Your Mother’ with quanteda"
author: "Alexander Kraess, Augusto Fonseca, Jorge Roa"
date: "16/11/2022"
output: 
  html_document:
    toc: TRUE
    df_print: paged
    number_sections: FALSE
    highlight: tango
    theme: lumen
    toc_depth: 3
    toc_float: true
    self_contained: false
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

------------------------------------------------------------------------
```{r, fig.align='left', echo=F, out.width = "30%"}
knitr::include_graphics("images/hertie_logo.png")


```



```{r, fig.align='center', echo=F, out.width = "60%"}
knitr::include_graphics("images/himym.png")


```



AXXXXXXXXXXXXXXXXXXXXXX

# Welcome to our tutorial about the Quanteda package!

YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY



**Step 1.** Load the packages which we will use (don't forget to install it before!).
```{r, message=F}
library(readtext)
library(tidyverse)
library(quanteda)
library(rvest)
library(quanteda.textstats)
library(quanteda.textplots)
library(stringr)
library(spacyr)
library(xml2)
library(ggsci)
```
# Scraping Wikipedia to get the data

If you don't want to go through this, you might go to the session "ZZZZZZZZZZZZZZZ".

ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ

**Step 1.** Scrap XXXXXXXXXX to get the episodes transcriptions.

```{r, message=F}

datalist_himym <- readtext::readtext("texts/how-i-met-your-mother/*.txt")

```


**Step 2.** Scrap Wikipedia to get the episodes and characters metadata and clean it!

```{r, message=F}

url_himym <- "https://en.wikipedia.org/wiki/List_of_How_I_Met_Your_Mother_episodes"

url_himym_characters <- "https://en.wikipedia.org/wiki/List_of_How_I_Met_Your_Mother_characters"

l_tables_himym <- url_himym %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  html_table(fill = TRUE)
l_tables_himym
#This generates a list with all the tables that contain the page. In our case, 
#we want the table from the second element till the 10th. 
l_tables_himym <- l_tables_himym[c(2:10)]



#Data cleaning to obtain clean tables

#Reduce the list in one data frame since all of the tables share the same structure 
df_himym <- data.frame(Reduce(bind_rows, l_tables_himym)) 

#We do the same for the characters of HIMYM
l_tables_himym_characters <- url_himym_characters %>% 
  read_html() %>% 
  html_nodes("table") %>% 
  html_table(fill = TRUE)

df_characters <- as.data.frame(l_tables_himym_characters[[1]]) %>% 
  select(Character)

df_characters_w <- df_characters %>% 
  filter(!stringr::str_starts(Character, "Futu"),
         !(Character %in% c("Character", "Main Characters", "Supporting Characters"))) %>% 
  mutate(name = str_extract(Character,"([^ ]+)"),
         name = replace(name, name == "Dr.", "Sonya"))

df_himym <- data.frame(Reduce(bind_rows, l_tables_himym)) 

df_himym_filt <- df_himym %>% filter(str_length(No.overall) < 4)

df_himym_filt_dupl <- df_himym %>% filter(str_length(No.overall) > 4)

df_himym_filt_dupl_1 <- df_himym_filt_dupl %>% 
  mutate(No.overall = as.numeric(replace(No.overall, str_length(No.overall) > 4, substr(No.overall, 1, 3))),
         No..inseason = as.numeric(replace(No..inseason, str_length(No..inseason) > 3, substr(No..inseason, 1, 2))),
         Prod.code = replace (Prod.code, str_length(Prod.code) > 3, substr(Prod.code, 1, 6)))

df_himym_filt_dupl_2 <- df_himym_filt_dupl %>% 
  mutate(No.overall = as.numeric(replace(No.overall, str_length(No.overall) > 4, substr(No.overall, 4, 6))),
         No..inseason = as.numeric(replace(No..inseason, str_length(No..inseason) > 3, substr(No..inseason, 3, 4))),
         Title = replace(Title, Title == "\"The Magician's Code\"", "\"The Magician's Code Part 2\""),
         Title = replace(Title, Title == "\"The Final Page\"", "\"The Final Page Part 2\""),
         Title = replace(Title, Title == "\"Last Forever\"" , "\"Last Forever Part 2\"" ),
         Prod.code = replace(Prod.code, str_length(Prod.code) > 3, substr(Prod.code, 7, 12)))

df_himym_final <- bind_rows(df_himym_filt, 
                            df_himym_filt_dupl_1, 
                            df_himym_filt_dupl_2) %>% 
  arrange(No.overall, No..inseason) %>% 
  mutate(year = str_extract(Original.air.date, '[0-9]{4}+'),
         Season = as.numeric(stringr::str_extract(Prod.code, "^.{1}"))) %>% 
  rename(Chapter = No..inseason)

df_himym_final$US.viewers.millions. <- as.numeric(str_replace_all(df_himym_final$US.viewers.millions., "\\[[0-9]+\\]", ""))

datalist_himym <- readtext::readtext("texts/how-i-met-your-mother/*.txt")

v_season <- as.numeric(stringr::str_extract(datalist_himym$doc_id, "\\d+"))

v_chapter <- as.numeric(stringi::stri_extract_last_regex(datalist_himym$doc_id, "[0-9]+"))

datalist_himym_w <- datalist_himym %>% mutate(Season = v_season, Chapter = v_chapter)

df_himym_final_doc <- full_join(as.data.frame(datalist_himym_w), df_himym_final, by = c("Season", "Chapter")) %>% 
  mutate(Season_w = paste("Season", Season))

## Final dataframe to be used as a corpus text

df_himym_final_doc

```

# Uploading data into Quanteda corpus

OK! It's showtime! Let's upload all our data into a Quanteda corpus element.

**Step 1.** First Step: Define a corpus

```{r, message=F}

corp_himym <- corpus(df_himym_final_doc)  # build a new corpus from the texts

docnames(corp_himym) <- df_himym_final_doc$Title

summary(corp_himym, n = 15)

```
**Step 2.** Convert corpus into tokens and wrangle it

```{r}

corp_himym_cleaned <- tokens(corp_himym, remove_punct = TRUE,
                        remove_separators = TRUE, 
                        remove_numbers = TRUE, 
                        remove_symbols = TRUE) %>%
  tokens_remove(stopwords("english"))


```

**Step 3.** Create a DFM.

```{r}

dfm_himym_cleaned <- corp_himym_cleaned %>% dfm()

tstat_simil <- textstat_simil(dfm_himym_cleaned)

tstat_dist <- textstat_dist(dfm_himym_cleaned)

```

# Now... let's have fun!

Now that we already upload the data and created the Quanteda elements, we can try some basics analysis.

**Step 1.** Let's choose a specific season


```{r, eval=F}
#Adjust this code to filter the DFM and not the corpus
corp_himym_s1 <- corpus_subset(dfm_himym_cleaned, Season == 1)

```


**Step 2** XXXXXXXXXXXXXXXXXXXXXXXXXXX`



```{r, eval=F}
#YYYYYYYYYYYYYYYY


```

**Step 3** XXXXXXXXXXXXXXXXXXXXXXXXXXX`



```{r, eval=F}
#YYYYYYYYYYYYYYYY


```

# XXXX Session

ThWWWWWWWWWWWWWWWWWWWW


**Step 1** XXXXXXXXXXXXXXXXXXXXXXXXXXX`



```{r, eval=F}
#YYYYYYYYYYYYYYYY


```

**Step 2** XXXXXXXXXXXXXXXXXXXXXXXXXXX`



```{r, eval=F}
#YYYYYYYYYYYYYYYY


```



# Sources

ZZZZZZZZZZZZZZZ
